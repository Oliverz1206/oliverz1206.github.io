## Technical overview

This document explains how the repository is structured, how the main pieces of the Jekyll + Chirpy setup interact, and where to look when you want to change specific behaviors (routing, layouts, indexes, etc.).

If you are trying to answer *“where should I edit to change X?”*, skim the sections below and jump to the relevant folder or plugin.

---

## Top-level layout

- **Root files**
  - **`_config.yml`**: Global site settings.
    - Site metadata: `title`, `tagline`, `description`, `url`, `social`, `github`.
    - UI options: `theme_mode`, `avatar`, `toc`, `comments`, PWA settings.
    - Collections: defines `tabs` as a collection with `layout: page` and pretty permalinks.
    - Build & markdown: `kramdown`, `sass`, `compress_html`, `exclude`.
    - Plugins & behavior: `plugins`, `jekyll-archives`, `hierarchical_topics`, `slugify`, `pagination`, `showcase`, `autopages`, `post_tail_format`.
  - **`Gemfile`** / **`.ruby-version`**:
    - Pin Ruby to `3.4.8` and the theme to `jekyll-theme-chirpy ~> 7.3`.
    - Adds extra plugins (`jekyll-archives`, `jekyll-paginate-v2`) and runtime gems (`webrick`, `logger`, `fiddle`).
  - **`README.md`**: High-level project and usage overview.
  - **`TECH.md`**: This technical mapping.
  - **`.nojekyll`**: Disables GitHub’s own Jekyll pass, making `_site` safe to deploy directly if you choose.

- **Core Jekyll / Chirpy structure**
  - **`_layouts/`**: HTML layouts that control the structure of pages, posts, archives, showcases, resume, and lists.
  - **`_includes/`**: Reusable partials (sidebar, topbar, pagination, related posts, JS selectors, etc.).
  - **`_tabs/`**: Source for top-level navigation tabs (Resume, Projects, Publications, Notes, Blogs, Tags, About).
  - **`_posts/`**: Blog-like content grouped by subfolder and category:
    - `_posts/projects/` – posts with `categories: [Projects]`.
    - `_posts/publications/` – posts with `categories: [Publications]`.
    - `_posts/blogs/` – posts with `categories: [Blogs]`.
  - **`_plugins/`**: Custom Ruby plugins that extend routing, pagination, permalinks, and indexing.
  - **`_data/`**: Small YAML files with configuration for sharing/contact.

- **Generated / cache**
  - **`_site/`**: Built static site (HTML, CSS, JS, images). **Never edit this manually**; it is regenerated by `jekyll build` / `jekyll serve`.
  - **`.jekyll-cache/`**: Jekyll’s internal build cache. Safe to delete; speeds up subsequent builds.

---

## Configuration details (`_config.yml`)

- **Site basics**
  - **`theme: jekyll-theme-chirpy`**: Uses the Chirpy theme from RubyGems.
  - **`lang`, `timezone`**: Language and time zone for date/time rendering.
  - **`title`, `tagline`, `description`**: Shown across the site and used in SEO metadata.
  - **`url`**: Production base URL (`https://oliverz1206.github.io`).
  - **`github`, `social`**: Usernames and profile links used in header/footer and author metadata.

- **Analytics & verification**
  - Place verification codes under `webmaster_verifications`.
  - Configure analytics (`google`, `goatcounter`, `umami`, `matomo`, `cloudflare`, `fathom`) under `analytics`.
  - `pageviews` supports `goatcounter` if enabled.

- **UI / PWA**
  - **`theme_mode`**: optional default light/dark mode; empty = follow system with toggle in sidebar.
  - **`avatar`**: sidebar avatar image path (currently `/assets/img/avatar/amia.png`).
  - **`social_preview_image`**: default OG image for sharing.
  - **`toc`**: global table-of-contents switch for posts.
  - **`comments`**: provider and options (`disqus`, `utterances`, `giscus`).
  - **`assets.self_host`**: toggle for self-hosting static assets.
  - **`pwa`**: installable PWA and offline cache (enabled by default here).

- **Collections & defaults**
  - **`collections.tabs`**: declares the `tabs` collection, with `output: true` and `sort_by: order`.
  - **`defaults`**:
    - Posts: `layout: post`, `comments: true`, `toc: true`, `permalink: /:categories/:title/`.
    - Drafts: `comments: false`.
    - Tabs: `layout: page`, `permalink: /:title/`.

- **Slug & hierarchical topics**
  - **`hierarchical_topics`**:
    - Example: `- Notes` — used by the hierarchical index generator to build `/notes/...` index pages.
  - **`slugify`**:
    - `mode: default` – uses default slug rules.
    - `slug_from_title: true` – prefers title-based slugs when filename-derived slug matches default.
    - `slug_rules_debug: false` – enable to debug slug/permalink decisions.

- **Pagination & showcases**
  - **`pagination`**:
    - Global `jekyll-paginate-v2` settings (`enabled`, `debug`).
  - **`showcase`**:
    - `enabled`, `debug`, `collection`, and nested `pagination` (`per_page`, `sort_reverse`).
    - Consumed by `_plugins/showcase-settings.rb` to control Projects / Publications pages.

- **Post-tail behavior**
  - **`post_tail_format`**:
    - `both`: categories that show **related posts + previous/next navigation** (e.g. `["Blogs"]`).
    - `post_nav_only`: only navigation.
    - `related_only`: only related posts (e.g. `["Notes"]`).
    - `none`: neither (e.g. `["Projects", "Publications"]`).
  - Implemented by `_plugins/page-classifier.rb`, consumed in `_layouts/post.html` via `page.tail_includes`.

---

## Tabs & navigation (`_tabs/`)

Tabs are small Markdown files with front matter. They define the sidebar/topbar navigation entries and connect to layouts and collections.

- **Common front matter fields**
  - `layout`: which layout to use (e.g. `page`, `resume`, `showcase`, `archive`, `lists`, `tags`).
  - `title`: label shown in the navigation and page title.
  - `icon`: Font Awesome icon class (e.g. `fas fa-file`).
  - `order`: numeric sort order in the nav.

- **Key tabs**
  - **`_tabs/resume.md`**
    - `layout: resume` – custom bilingual resume layout.
    - `download_en` / `download_cn`: links to downloadable PDFs.
    - Content is split by `<!--lang:en-->` and `<!--lang:cn-->`; see `_layouts/resume.html`.
  - **`_tabs/projects.md`**
    - `layout: showcase`, `title: Projects`, `refactor: true`.
    - The `showcase` plugin uses this tab as an entry point and pulls posts from the `posts` collection with `categories: [Projects]`.
  - **`_tabs/publications.md`**
    - Also `layout: showcase`, `title: Publications`.
    - Uses the same machinery but targets the `Publications` category.
  - **`_tabs/notes.md`**
    - `layout: lists`, `title: Notes`.
    - Acts as the root for the Notes hierarchy, using lists + hierarchical index pages from the plugin.
  - **`_tabs/blogs.md`**
    - `layout: archive`, `title: Blogs`.
    - Lists posts whose `categories[0] == "Blogs"` grouped by year.
  - **`_tabs/tags.md`**
    - `layout: tags` (theme-provided) to show a tag overview.
  - **`_tabs/about.md`**
    - `layout: page` with a basic tip; fill in Markdown content here for an About page.

If the navigation order or labels look wrong, **start here** and adjust `order`, `title`, or `icon`.

---

## Content organization (`_posts/`)

Posts are grouped by subfolder under `_posts/`, and by their `categories` front matter.

- **Projects** – `_posts/projects/`
  - Example: `_posts/projects/2025-06-18-ProjectTest1.md`
  - Typical front matter:

```yaml
title: Project 1
date: 2025-06-18 10:00:00 +0800
categories: [Projects]
tags: [test]
description: Short description
image:
  path: /assets/img/projects/project1/cover.jpg
```

  - Shown on the Projects tab as cards (via `showcase.html` and `showcase-settings.rb`).

- **Publications** – `_posts/publications/`
  - Similar structure, but `categories: [Publications]`.
  - Intended for papers / articles and rendered in the Publications showcase.

- **Blogs** – `_posts/blogs/`
  - `categories: [Blogs]`.
  - Displayed in reverse chronological order on the Blogs tab using `archive.html`.

- **Notes**
  - Notes are conceptually `categories[0] == Notes` with deeper levels for area and topic:

```yaml
categories: [Notes, "Computer Engineering", "CPU"]
```

  - The `hierarchical-indexes.rb` plugin and `lists` / `list` layouts use these categories to:
    - Generate `/notes/<area>/` and `/notes/<area>/<topic>/` index pages.
    - Build a collapsible tree under the Notes tab.
  - If you add or move notes, keep this category structure consistent so the hierarchy remains correct.

When you want to create a new item in any section, **copy an existing post in the same subfolder** and update the front matter.

---

## Layouts (`_layouts/`)

These templates control page structure and are the main place to adjust HTML markup and how data is displayed.

- **`post.html`**
  - Main layout for posts (`layout: post`).
  - Features:
    - Splits `page.title` into main title and subtitle using a `Title | Subtitle` pattern.
    - Renders metadata: published date, optional `last_modified_at`, featured image, author, pageviews, read time.
    - Shows categories and tags at the bottom.
    - Uses `page.tail_includes` to decide which post-tail components to render (e.g. `related-posts`, `post-nav`).
      - Tail includes are determined by `_plugins/page-classifier.rb` based on top-level category.
  - **Edit here** to:
    - Change post header layout, meta display, or how categories/tags look.

- **`showcase.html`**
  - Card-style listing layout used for Projects and Publications.
  - Iterates over `paginator.posts` to build cards with:
    - Optional preview image (`post.image`), title, summary, date, and up to three tags.
    - Pin indicator if `post.pin` is true.
  - Paginator at the bottom uses `post-paginator.html`.
  - Input (which posts appear and in what order) is controlled by:
    - `_plugins/showcase-settings.rb`
    - `_config.yml.showcase` (pagination values).

- **`resume.html`**
  - Custom layout for the resume tab.
  - Responsibilities:
    - Parses the content into English and Chinese blocks using `<!--lang:en-->` and `<!--lang:cn-->`.
    - Provides a **language toggle** button and **Download PDF** button with data attributes for both languages.
    - Renders each language block through `markdownify`.
  - Front matter options:
    - `download_en` / `download_cn`: PDF URLs.
    - `default_lang`: `"en"` or `"cn"` (initial language).
    - `remember_lang`: whether to remember the last selection (used by JS).

- **`lists.html`**
  - Root layout for hierarchical listings (e.g. Notes overview).
  - Renders `content` (intro text) followed by a collapsible list of:
    - Level 1 categories (`categories[1]`) and their counts.
    - Nested level 2 categories (`categories[2]`).
    - Direct posts attached at L1 and L2.
  - Uses URLs formed from slugified category names: `/notes/<l1>/` and `/notes/<l1>/<l2>/`.

- **`list.html`**
  - Simple list layout for a single category page (e.g. `/notes/<l1>/` or `/notes/<l1>/<l2>/`).
  - Data fields provided by the hierarchical indexes generator:
    - `page.top`, `page.level1`, `page.level2`, `page.title`, `page.posts`.
  - Displays a heading with name and count, followed by a list of posts with dates.

- **`archive.html`**
  - Archive layout (Chirpy-style) used for Blogs.
  - Selects posts with `categories[0] == page.title`.
  - Groups posts by year and renders each with day/month and a link.

If you want to change **how** a section looks (card layout vs list vs archive), come here first.

---

## Includes (`_includes/`)

Only the customized includes are listed here; many others live in the theme gem.

- **`related-posts.html`**
  - Computes a similarity score between the current page and candidate posts:
    - `TAG_SCORE` (1) for each shared tag.
    - `CATEGORY_SCORE` (0.5) for overlapping non-top-level categories.
  - Picks the top `TOTAL_SIZE` results (currently `3`) and renders them as cards.
  - Pool:
    - `site.categories[top]` where `top = page.categories[0]`, or `site.posts` if no top category.

- **`post-nav.html`**
  - Previous/next post navigation at the bottom of posts.

- **`post-paginator.html`**
  - Pagination bar used on card/list pages when `paginator.total_pages > 1`.

- **`topbar.html` / `sidebar.html`**
  - Control global header and side navigation UI.
  - Good places to tweak logos, avatar, or link ordering beyond what `_tabs` provides.

- **`metadata-hook.html` / `js-selector.html` / `refactor-content.html`**
  - Support scripts/hooks to integrate with the refactored layouts and JS pipeline.

When you need to adjust just a small reusable piece (e.g. change how related posts look), edit the corresponding include instead of a full layout.

---

## Plugins (`_plugins/`)

These Ruby plugins are the “glue” that connect your content model with Chirpy’s rendering.

- **`showcase-settings.rb` – Showcase integrator**
  - Runs as a `Jekyll::Generator` with `priority :highest` and via hooks.
  - Main responsibilities:
    - Disable direct output of `layout: showcase` documents in collections other than `posts` (e.g. `_tabs`) to avoid URL conflicts.
    - Compute `showcase_rank` for posts:
      - `showcase_rank = pin_weight + epoch`, where `pin_weight` is a large constant for `pin: true`.
    - For each `_tabs` document with `layout: showcase`:
      - Creates a `PageWithoutAFile` at the tab’s URL (e.g. `/projects/`, `/publications/`).
      - Injects a `pagination` block configured for:
        - `collection: posts`, optional `category: <tab title>`,
        - `sort_field: showcase_rank`, `sort_reverse`.
    - Ensures all `layout: showcase` pages have a proper `pagination.title`.
  - Configuration is under `_config.yml.showcase`.
  - **Change here** if you want:
    - Different sort rules for showcases.
    - Different pagination defaults (e.g. per-page count).

- **`posts-lastmod-hook.rb` – Last modified timestamps**
  - Hook: `Jekyll::Hooks.register :posts, :post_init`.
  - For each post, if Git commit count for that file is greater than 1:
    - Fetches the latest commit timestamp using Git CLI.
    - Writes `post.data['last_modified_at']` as ISO 8601 UTC.
  - `_layouts/post.html` then displays this as an “updated” date.
  - Requires that the build environment has access to Git history (e.g. `fetch-depth: 0` in CI).

- **`permalink-normalizer.rb` – Slug / permalink rules**
  - Hook: `:documents, :post_init` + generator with `priority :highest`.
  - For documents in the `posts` collection:
    - Collects `categories` and slugifies each to build the URL path.
    - Determines a final `slug` using:
      - Filename tail (`YYYY-MM-DD-...` trimmed),
      - Existing `slug` (if any),
      - Optionally, title-based slug when `slug_from_title: true`.
    - Writes back:
      - `doc.data["slug"]`
      - `doc.data["permalink"]` as either `/<slug>/` or `/cat1/cat2/<slug>/`.
  - Controlled by `_config.yml.slugify`.
  - **Adjust here** if you want custom slug logic or different permalink patterns.

- **`page-classifier.rb` – Post-tail classifier**
  - Hook: `Jekyll::Hooks.register :posts, :post_init`.
  - Reads `_config.yml.post_tail_format` and standardizes each list.
  - Computes top-level category:
    - Prefer `categories[0]`.
    - If missing, infer from path `_posts/<top>/...`.
  - Sets `post.data["tail_includes"]` to one of:
    - `["related-posts", "post-nav"]` (both),
    - `["post-nav"]`,
    - `["related-posts"]`,
    - `[]` (none).
  - `_layouts/post.html` then includes these components by name.

- **`hierarchical-indexes.rb` – Hierarchical notes indexes**
  - Uses `hierarchical_topics` from `_config.yml` (e.g. `["Notes"]`).
  - For each configured top-level category:
    - Scans `site.posts.docs` where `categories[0]` equals that top.
    - Builds a tree of `level1 = categories[1]` and `level2 = categories[2]` values.
    - Generates index pages (as `HierIndexPage` objects) at:
      - `/top_slug/level1_slug/`
      - `/top_slug/level1_slug/level2_slug/`
    - Each index uses `_layouts/list.html` and exposes `page.top`, `page.level1`, `page.level2`, `page.posts`.
  - Works together with `lists.html` (L1/L2 tree) and the Notes tab.
  - **Modify here** if you want deeper nesting, a different URL scheme, or to extend indexing to other top-level categories beyond Notes.

Whenever you see behavior that “magically happens” (custom pagination, permalinks, hierarchical indexes), look in `_plugins/` first.

---

## Data files (`_data/`)

- **`_data/share.yml`**
  - Configuration for social sharing services & buttons.
- **`_data/contact.yml`**
  - Contact-related configuration (likely used by sidebar/footer partials).

These YAML files are a good place to centralize values that may appear in multiple layouts/includes.

---

## Where to change what – quick mapping

- **Change site title, description, avatar, or social links**
  - Edit `_config.yml` (`title`, `tagline`, `description`, `avatar`, `social`).

- **Change navigation items (text, order, icon, or target section)**
  - Edit `_tabs/*.md`.
  - Adjust `order`, `title`, and `icon`; change `layout` to swap how a tab is rendered.

- **Change how Projects / Publications lists look**
  - Visual layout: `_layouts/showcase.html`.
  - Sorting & pagination logic: `_plugins/showcase-settings.rb` and `_config.yml.showcase`.

- **Change how the resume behaves**
  - Layout (toggle, buttons, structure): `_layouts/resume.html`.
  - Content: `_tabs/resume.md`.
  - Download targets: `download_en` / `download_cn` in resume tab front matter.

- **Change how Notes navigation and indexes work**
  - Tree UI: `_layouts/lists.html`.
  - Per-category index pages: `_layouts/list.html` and `_plugins/hierarchical-indexes.rb`.
  - Which top-level categories participate: `_config.yml.hierarchical_topics`.

- **Adjust related posts / previous–next behavior**
  - Tail selection rules: `_plugins/page-classifier.rb` + `_config.yml.post_tail_format`.
  - Related posts scoring & rendering: `_includes/related-posts.html`.
  - Previous/next navigation markup: `_includes/post-nav.html`.

- **Adjust permalinks or slug rules**
  - High-level options: `_config.yml.slugify`.
  - Implementation details: `_plugins/permalink-normalizer.rb`.

- **Control analytics, comments, and PWA caching**
  - Analytics & comments: `_config.yml.analytics`, `_config.yml.comments`.
  - PWA: `_config.yml.pwa`.

Use this section as a “jump table”: when you decide what you want to improve, locate the corresponding file(s) above and start iterating there.

